<html>
<head>

<script src="rtws.js"></script>
<script src="amf0.js"></script>
<script src="tcmessage.js"></script>
<script src="tcconn.js"></script>
<script src="tcaudio.js"></script>
<script src="tcmedia.js"></script>

<script>

var connection;
var channelStream;
var mediaDecoder;

function onResize() {
	video.width = Math.floor(video.parentElement.clientWidth);
	video.height = Math.floor(video.parentElement.clientHeight);
}

function doPlay() {
	if(channelStream && stream_name.value)
		channelStream.play(stream_name.value);
}

function doCloseStream() {
	channelStream?.closeStream();
	mediaDecoder?.audioFlush();
}

function onDisconnected(e) {
	if(e)
		console.log("onDisconnected", e);

	connection?.close();

	connection = null;
	channelStream = null;

	button_disconnect.disabled = true;
	button_connect.disabled = false;
	server_uri.disabled = false;
	tcurl_override.disabled = false;
	app_override.disabled = false;
	auth_token.disabled = false;
	button_play.disabled = true;
	button_closestream.disabled = true;

	mediaDecoder?.close();
	mediaDecoder = null;
}

async function onConnected(info) {
	channelStream = await connection.createStream();
	mediaDecoder = new com_zenomt_TCMediaDecoder(channelStream);
	mediaDecoder.drawFramesToCanvas(video);
	mediaDecoder.audioController.onstatus = (e) => console.log("audioController.onstatus", e.detail, e);

	button_play.disabled = false;
	button_closestream.disabled = false;
}

function doConnect() {
	if(!server_uri.value)
		return;

	button_connect.disabled = true;
	button_disconnect.disabled = false;
	server_uri.disabled = true;
	tcurl_override.disabled = true;
	app_override.disabled = true;
	auth_token.disabled = true;

	connection = new com_zenomt_TCConnection();
	connection.onclose = onDisconnected;
	connection.connect(server_uri.value, {
			tcUrl:tcurl_override.value || server_uri.value,
			app:app_override.value || undefined,
			videoCodecs:(1 << com_zenomt_TCMessage.TC_VIDEO_CODEC_AVC),
			audioCodecs:0xffff, // cheat and say all of them
		}, auth_token.value).then(onConnected).catch(onDisconnected);
}

function doDisconnect() {
	if(connection)
		connection.close();
	else
		onDisconnected();
}

function populateOverrides() {
	tcurl_override.placeholder = server_uri.value;
	app_override.placeholder = com_zenomt_TCConnection.appFromTcUrl(tcurl_override.value || server_uri.value);
}

function onLoaded() {
	window.addEventListener("resize", onResize);
	onDisconnected();
	onResize();

	server_uri.onchange = server_uri.oninput = tcurl_override.onchange = tcurl_override.oninput = populateOverrides;
	populateOverrides();
}

</script>

<title>Play Stream Demo</title>
</head>

<body onload="onLoaded()" style="display: grid; grid-template-rows: auto 1fr;">

<div>
	<h1>Play Stream Demo</h1>
	<table cellpadding="3">
	<tr> <td>Server</td><td><input type="text" size="48" id="server_uri" placeholder="websocket url" value="ws://localhost:8080/live" /> <input type="text" size="64" id="auth_token" placeholder="authentication token" /> </td> </tr>
	<tr> <td>Overrides</td> <td><input type="text" size="48" id="tcurl_override" title="tcUrl override" /> <input type="text" size="48" id="app_override" title="app override" /> </td> </tr>
	<tr>
		<td></td>
		<td>
			<button type="button" id="button_connect" onclick="doConnect()">Connect</button>
			<button type="button" id="button_disconnect" onclick="doDisconnect()">Disconnect</button>
		</td>
	</tr>
	<tr>
		<td>Stream</td>
		<td>
			<input type="text" size="80" id="stream_name" placeholder="stream name" value="live"/>
			<button type="button" id="button_play" onclick="doPlay()">Play</button>
			<button type="button" id="button_closestream" onclick="doCloseStream()">Close Stream</button>
		</td>
	</tr>
	</table>
	<hr/>
</div>

<div style="width: 100%; overflow:hidden;">
	<canvas id="video"></canvas>
</div>

</body>
</html>
